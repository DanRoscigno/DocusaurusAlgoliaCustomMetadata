"use strict";(self.webpackChunkstarrocks=self.webpackChunkstarrocks||[]).push([[53939],{51132:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>i,default:()=>h,frontMatter:()=>r,metadata:()=>d,toc:()=>l});var a=t(85893),s=t(11151);const r={displayed_sidebar:"English"},i="Java UDFs",d={id:"sql-reference/sql-functions/JAVA_UDF",title:"Java UDFs",description:"From v2.2.0 onwards, you can compile user-defined functions (UDFs) to suit your specific business needs by using the Java programming language.",source:"@site/versioned_docs/version-2.5/sql-reference/sql-functions/JAVA_UDF.md",sourceDirName:"sql-reference/sql-functions",slug:"/sql-reference/sql-functions/JAVA_UDF",permalink:"/docs/2.5/sql-reference/sql-functions/JAVA_UDF",draft:!1,unlisted:!1,editUrl:"https://github.com/StarRocks/starrocks/edit/main/docs/sql-reference/sql-functions/JAVA_UDF.md",tags:[],version:"2.5",frontMatter:{displayed_sidebar:"English"},sidebar:"English",previous:{title:"convert_tz",permalink:"/docs/2.5/sql-reference/sql-functions/How_to_Write_Functions_Documentation"},next:{title:"Lambda expression",permalink:"/docs/2.5/sql-reference/sql-functions/Lambda_expression"}},c={},l=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Develop and use UDFs",id:"develop-and-use-udfs",level:2},{value:"Step 1: Create a Maven project",id:"step-1-create-a-maven-project",level:3},{value:"Step 2: Add dependencies",id:"step-2-add-dependencies",level:3},{value:"Step 3: Compile a UDF",id:"step-3-compile-a-udf",level:3},{value:"Compile a scalar UDF",id:"compile-a-scalar-udf",level:4},{value:"Compile a UDAF",id:"compile-a-udaf",level:4},{value:"Compile a UDWF",id:"compile-a-udwf",level:4},{value:"Compile a UDTF",id:"compile-a-udtf",level:4},{value:"Step 4: Package the Java project",id:"step-4-package-the-java-project",level:3},{value:"Step 5: Upload the Java project",id:"step-5-upload-the-java-project",level:3},{value:"Step 6: Create the UDF in StarRocks",id:"step-6-create-the-udf-in-starrocks",level:3},{value:"Syntax",id:"syntax",level:4},{value:"Parameters",id:"parameters",level:4},{value:"Create a scalar UDF",id:"create-a-scalar-udf",level:4},{value:"Create a UDAF",id:"create-a-udaf",level:4},{value:"Create a UDWF",id:"create-a-udwf",level:4},{value:"Create a UDTF",id:"create-a-udtf",level:4},{value:"Step 7: Use the UDF",id:"step-7-use-the-udf",level:3},{value:"Use a scalar UDF",id:"use-a-scalar-udf",level:4},{value:"Use a UDAF",id:"use-a-udaf",level:4},{value:"Use a UDWF",id:"use-a-udwf",level:4},{value:"Use a UDTF",id:"use-a-udtf",level:4},{value:"View UDFs",id:"view-udfs",level:2},{value:"Drop UDF",id:"drop-udf",level:2},{value:"Mapping between SQL data types and Java data types",id:"mapping-between-sql-data-types-and-java-data-types",level:2},{value:"Parameter settings",id:"parameter-settings",level:2},{value:"FAQ",id:"faq",level:2}];function o(e){const n=Object.assign({h1:"h1",p:"p",h2:"h2",ul:"ul",li:"li",a:"a",code:"code",strong:"strong",h3:"h3",pre:"pre",h4:"h4",blockquote:"blockquote",table:"table",thead:"thead",tr:"tr",th:"th",tbody:"tbody",td:"td"},(0,s.ah)(),e.components);return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.h1,{id:"java-udfs",children:"Java UDFs"}),"\n",(0,a.jsx)(n.p,{children:"From v2.2.0 onwards, you can compile user-defined functions (UDFs) to suit your specific business needs by using the Java programming language."}),"\n",(0,a.jsx)(n.p,{children:"This topic describes the types of UDFs supported by StarRocks, how to develop UDFs, and how to use the UDFs you have developed."}),"\n",(0,a.jsx)(n.p,{children:"Currently, StarRocks supports scalar UDFs, user-defined aggregate functions (UDAFs), user-defined window functions (UDWFs), and user-defined table functions (UDTFs)."}),"\n",(0,a.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:["You have installed ",(0,a.jsx)(n.a,{href:"https://maven.apache.org/download.cgi",children:"Apache Maven"}),", so you can create and compile Java projects."]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"You have installed JDK 1.8 on your servers."}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:["The Java UDF feature is enabled. You can set the FE configuration item ",(0,a.jsx)(n.code,{children:"enable_udf"})," to ",(0,a.jsx)(n.code,{children:"true"})," in the FE configuration file ",(0,a.jsx)(n.strong,{children:"fe/conf/fe.conf"})," to enable this feature, and then restart the FE nodes to make the settings take effect. For more information, see ",(0,a.jsx)(n.a,{href:"/docs/2.5/administration/Configuration",children:"Parameter configuration"}),"."]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"develop-and-use-udfs",children:"Develop and use UDFs"}),"\n",(0,a.jsx)(n.p,{children:"You need to create a Maven project and compile the UDF you need by using the Java programming language."}),"\n",(0,a.jsx)(n.h3,{id:"step-1-create-a-maven-project",children:"Step 1: Create a Maven project"}),"\n",(0,a.jsx)(n.p,{children:"Create a Maven project, whose basic directory structure is as follows:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-Plain",children:"project\n|--pom.xml\n|--src\n|  |--main\n|  |  |--java\n|  |  |--resources\n|  |--test\n|--target\n"})}),"\n",(0,a.jsx)(n.h3,{id:"step-2-add-dependencies",children:"Step 2: Add dependencies"}),"\n",(0,a.jsxs)(n.p,{children:["Add the following dependencies to the ",(0,a.jsx)(n.strong,{children:"pom.xml"})," file:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-XML",children:'<?xml version="1.0" encoding="UTF-8"?>\n<project xmlns="http://maven.apache.org/POM/4.0.0"\n        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"\n        xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">\n    <modelVersion>4.0.0</modelVersion>\n\n    <groupId>org.example</groupId>\n    <artifactId>udf</artifactId>\n    <version>1.0-SNAPSHOT</version>\n\n    <properties>\n        <maven.compiler.source>8</maven.compiler.source>\n        <maven.compiler.target>8</maven.compiler.target>\n    </properties>\n\n    <dependencies>\n        <dependency>\n            <groupId>com.alibaba</groupId>\n            <artifactId>fastjson</artifactId>\n            <version>1.2.76</version>\n        </dependency>\n    </dependencies>\n\n    <build>\n        <plugins>\n            <plugin>\n                <groupId>org.apache.maven.plugins</groupId>\n                <artifactId>maven-dependency-plugin</artifactId>\n                <version>2.10</version>\n                <executions>\n                    <execution>\n                        <id>copy-dependencies</id>\n                        <phase>package</phase>\n                        <goals>\n                            <goal>copy-dependencies</goal>\n                        </goals>\n                        <configuration>\n                            <outputDirectory>${project.build.directory}/lib</outputDirectory>\n                        </configuration>\n                    </execution>\n                </executions>\n            </plugin>\n            <plugin>\n                <groupId>org.apache.maven.plugins</groupId>\n                <artifactId>maven-assembly-plugin</artifactId>\n                <version>3.3.0</version>\n                <executions>\n                    <execution>\n                        <id>make-assembly</id>\n                        <phase>package</phase>\n                        <goals>\n                            <goal>single</goal>\n                        </goals>\n                    </execution>\n                </executions>\n                <configuration>\n                    <descriptorRefs>\n                        <descriptorRef>jar-with-dependencies</descriptorRef>\n                    </descriptorRefs>\n                </configuration>\n            </plugin>\n        </plugins>\n    </build>\n</project>\n'})}),"\n",(0,a.jsx)(n.h3,{id:"step-3-compile-a-udf",children:"Step 3: Compile a UDF"}),"\n",(0,a.jsx)(n.p,{children:"Use the Java programming language to compile a UDF."}),"\n",(0,a.jsx)(n.h4,{id:"compile-a-scalar-udf",children:"Compile a scalar UDF"}),"\n",(0,a.jsxs)(n.p,{children:["A scalar UDF operates on a single row of data and returns a single value. When you use a scalar UDF in a query, each row corresponds to a single value in the result set. Typical scalar functions include ",(0,a.jsx)(n.code,{children:"UPPER"}),", ",(0,a.jsx)(n.code,{children:"LOWER"}),", ",(0,a.jsx)(n.code,{children:"ROUND"}),", and ",(0,a.jsx)(n.code,{children:"ABS"}),"."]}),"\n",(0,a.jsxs)(n.p,{children:["Suppose that the values of a field in your JSON data are JSON strings rather than JSON objects. When you use an SQL statement to extract JSON strings, you need to run ",(0,a.jsx)(n.code,{children:"GET_JSON_STRING"})," twice, for example, ",(0,a.jsx)(n.code,{children:'GET_JSON_STRING(GET_JSON_STRING(\'{"key":"{\\\\"k0\\\\":\\\\"v0\\\\"}"}\', "$.key"), "$.k0")'}),"."]}),"\n",(0,a.jsxs)(n.p,{children:["To simplify the SQL statement, you can compile a scalar UDF that can directly extract JSON strings, for example, ",(0,a.jsx)(n.code,{children:'MY_UDF_JSON_GET(\'{"key":"{\\\\"k0\\\\":\\\\"v0\\\\"}"}\', "$.key.k0")'}),"."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-Java",children:"package com.starrocks.udf.sample;\n\nimport com.alibaba.fastjson.JSONPath;\n\npublic class UDFJsonGet {\n    public final String evaluate(String obj, String key) {\n        if (obj == null || key == null) return null;\n        try {\n            // The JSONPath library can be fully expanded even if the values of a field are JSON strings.\n            return JSONPath.read(obj, key).toString();\n        } catch (Exception e) {\n            return null;\n        }\n    }\n}\n"})}),"\n",(0,a.jsx)(n.p,{children:"The user-defined class must implement the method described in the following table."}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"NOTE"})}),"\n",(0,a.jsxs)(n.p,{children:["The data types of the request parameters and return parameters in the method must be the same as those declared in the ",(0,a.jsx)(n.code,{children:"CREATE FUNCTION"})," statement that is to be executed in ",(0,a.jsx)(n.a,{href:"#step-6-create-the-udf-in-starrocks",children:"Step 6"}),' and conform to the mapping that is provided in the "',(0,a.jsx)(n.a,{href:"#mapping-between-sql-data-types-and-java-data-types",children:"Mapping between SQL data types and Java data types"}),'" section of this topic.']}),"\n"]}),"\n",(0,a.jsxs)(n.table,{children:[(0,a.jsx)(n.thead,{children:(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.th,{children:"Method"}),(0,a.jsx)(n.th,{children:"Description"})]})}),(0,a.jsx)(n.tbody,{children:(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"TYPE1 evaluate(TYPE2, ...)"}),(0,a.jsx)(n.td,{children:"Runs the UDF. The evaluate() method requires the public member access level."})]})})]}),"\n",(0,a.jsx)(n.h4,{id:"compile-a-udaf",children:"Compile a UDAF"}),"\n",(0,a.jsxs)(n.p,{children:["A UDAF operates on multiple rows of data and returns a single value. Typical aggregate functions include ",(0,a.jsx)(n.code,{children:"SUM"}),", ",(0,a.jsx)(n.code,{children:"COUNT"}),", ",(0,a.jsx)(n.code,{children:"MAX"}),", and ",(0,a.jsx)(n.code,{children:"MIN"}),", which aggregate multiple rows of data specified in each GROUP BY clause and return a single value."]}),"\n",(0,a.jsxs)(n.p,{children:["Suppose that you want to compile a UDAF named ",(0,a.jsx)(n.code,{children:"MY_SUM_INT"}),". Unlike the built-in aggregate function ",(0,a.jsx)(n.code,{children:"SUM"}),", which returns BIGINT-type values, the ",(0,a.jsx)(n.code,{children:"MY_SUM_INT"})," function supports only request parameters and returns parameters of the INT data type."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-Java",children:"package com.starrocks.udf.sample;\n\npublic class SumInt {\n    public static class State {\n        int counter = 0;\n        public int serializeLength() { return 4; }\n    }\n\n    public State create() {\n        return new State();\n    }\n\n    public void destroy(State state) {\n    }\n\n    public final void update(State state, Integer val) {\n        if (val != null) {\n            state.counter+= val;\n        }\n    }\n\n    public void serialize(State state, java.nio.ByteBuffer buff) {\n        buff.putInt(state.counter);\n    }\n\n    public void merge(State state, java.nio.ByteBuffer buffer) {\n        int val = buffer.getInt();\n        state.counter += val;\n    }\n\n    public Integer finalize(State state) {\n        return state.counter;\n    }\n}\n"})}),"\n",(0,a.jsx)(n.p,{children:"The user-defined class must implement the methods described in the following table."}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"NOTE"})}),"\n",(0,a.jsxs)(n.p,{children:["The data types of the request parameters and return parameters in the methods must be the same as those declared in the ",(0,a.jsx)(n.code,{children:"CREATE FUNCTION"})," statement that is to be executed in ",(0,a.jsx)(n.a,{href:"#step-6-create-the-udf-in-starrocks",children:"Step 6"}),' and conform to the mapping that is provided in the "',(0,a.jsx)(n.a,{href:"#mapping-between-sql-data-types-and-java-data-types",children:"Mapping between SQL data types and Java data types"}),'" section of this topic.']}),"\n"]}),"\n",(0,a.jsxs)(n.table,{children:[(0,a.jsx)(n.thead,{children:(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.th,{children:"Method"}),(0,a.jsx)(n.th,{children:"Description"})]})}),(0,a.jsxs)(n.tbody,{children:[(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"State create()"}),(0,a.jsx)(n.td,{children:"Creates a state."})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"void destroy(State)"}),(0,a.jsx)(n.td,{children:"Destroys a state."})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"void update(State, ...)"}),(0,a.jsxs)(n.td,{children:["Updates a state. In addition to the first parameter ",(0,a.jsx)(n.code,{children:"State"}),", you can also specify one or more request parameters in the UDF declaration."]})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"void serialize(State, ByteBuffer)"}),(0,a.jsx)(n.td,{children:"Serializes a state into the byte buffer."})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"void merge(State, ByteBuffer)"}),(0,a.jsx)(n.td,{children:"Deserializes a state from the byte buffer, and merges the byte buffer into the state as the first parameter."})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"TYPE finalize(State)"}),(0,a.jsx)(n.td,{children:"Obtains the final result of the UDF from a state."})]})]})]}),"\n",(0,a.jsxs)(n.p,{children:["During compilation, you must also use the buffer class ",(0,a.jsx)(n.code,{children:"java.nio.ByteBuffer"})," and the local variable ",(0,a.jsx)(n.code,{children:"serializeLength"}),", which are described in the following table."]}),"\n",(0,a.jsxs)(n.table,{children:[(0,a.jsx)(n.thead,{children:(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.th,{children:"Class and local variable"}),(0,a.jsx)(n.th,{children:"Description"})]})}),(0,a.jsxs)(n.tbody,{children:[(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"java.nio.ByteBuffer()"}),(0,a.jsxs)(n.td,{children:["The buffer class, which stores intermediate results. Intermediate results may be serialized or deserialized when they are transmitted between nodes for execution. Therefore, you must also use the ",(0,a.jsx)(n.code,{children:"serializeLength"})," variable to specify the length that is allowed for the deserialization of intermediate results."]})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"serializeLength()"}),(0,a.jsxs)(n.td,{children:["The length that is allowed for the deserialization of intermediate results. Unit: bytes. Set this local variable to an INT-type value. For example, ",(0,a.jsx)(n.code,{children:"State { int counter = 0; public int serializeLength() { return 4; }}"})," specifies that intermediate results are of the INT data type and the length for deserialization is 4 bytes. You can adjust these settings based on your business requirements. For example, if you want to specify the data type of intermediate results as LONG and the length for deserialization as 8 bytes, pass ",(0,a.jsx)(n.code,{children:"State { long counter = 0; public int serializeLength() { return 8; }}"}),"."]})]})]})]}),"\n",(0,a.jsxs)(n.p,{children:["Take note of the following points for the deserialization of intermediate results stored in the ",(0,a.jsx)(n.code,{children:"java.nio.ByteBuffer"})," class:"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["The ",(0,a.jsx)(n.code,{children:"remaining()"})," method that is dependent on the ",(0,a.jsx)(n.code,{children:"ByteBuffer"})," class cannot be called to deserialize a state."]}),"\n",(0,a.jsxs)(n.li,{children:["The ",(0,a.jsx)(n.code,{children:"clear()"})," method cannot be called on the ",(0,a.jsx)(n.code,{children:"ByteBuffer"})," class."]}),"\n",(0,a.jsxs)(n.li,{children:["The value of ",(0,a.jsx)(n.code,{children:"serializeLength"})," must be the same as the length of the written-in data. Otherwise, incorrect results are generated during serialization and deserialization."]}),"\n"]}),"\n",(0,a.jsx)(n.h4,{id:"compile-a-udwf",children:"Compile a UDWF"}),"\n",(0,a.jsxs)(n.p,{children:["Unlike regular aggregate functions, a UDWF operates on a set of multiple rows, which are collectively called a window, and returns a value for each row. A typical window function includes an ",(0,a.jsx)(n.code,{children:"OVER"})," clause that divides rows into multiple sets. It performs a calculation across each set of rows and returns a value for each row."]}),"\n",(0,a.jsxs)(n.p,{children:["Suppose that you want to compile a UDWF named ",(0,a.jsx)(n.code,{children:"MY_WINDOW_SUM_INT"}),". Unlike the built-in aggregate function ",(0,a.jsx)(n.code,{children:"SUM"}),", which returns BIGINT-type values, the ",(0,a.jsx)(n.code,{children:"MY_WINDOW_SUM_INT"})," function supports only request parameters and returns parameters of the INT data type."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-Java",children:'package com.starrocks.udf.sample;\n\npublic class WindowSumInt {    \n    public static class State {\n        int counter = 0;\n        public int serializeLength() { return 4; }\n        @Override\n        public String toString() {\n            return "State{" +\n                    "counter=" + counter +\n                    \'}\';\n        }\n    }\n\n    public State create() {\n        return new State();\n    }\n\n    public void destroy(State state) {\n\n    }\n\n    public void update(State state, Integer val) {\n        if (val != null) {\n            state.counter+=val;\n        }\n    }\n\n    public void serialize(State state, java.nio.ByteBuffer buff) {\n        buff.putInt(state.counter);\n    }\n\n    public void merge(State state, java.nio.ByteBuffer buffer) {\n        int val = buffer.getInt();\n        state.counter += val;\n    }\n\n    public Integer finalize(State state) {\n        return state.counter;\n    }\n\n    public void reset(State state) {\n        state.counter = 0;\n    }\n\n    public void windowUpdate(State state,\n                            int peer_group_start, int peer_group_end,\n                            int frame_start, int frame_end,\n                            Integer[] inputs) {\n        for (int i = (int)frame_start; i < (int)frame_end; ++i) {\n            state.counter += inputs[i];\n        }\n    }\n}\n'})}),"\n",(0,a.jsxs)(n.p,{children:["The user-defined class must implement the method required by UDAFs (because a UDWF is a special aggregate function) and the ",(0,a.jsx)(n.code,{children:"windowUpdate()"})," method described in the following table."]}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"NOTE"})}),"\n",(0,a.jsxs)(n.p,{children:["The data types of the request parameters and return parameters in the method must be the same as those declared in the ",(0,a.jsx)(n.code,{children:"CREATE FUNCTION"})," statement that is to be executed in ",(0,a.jsx)(n.a,{href:"#step-6-create-the-udf-in-starrocks",children:"Step 6"}),' and conform to the mapping that is provided in the "',(0,a.jsx)(n.a,{href:"#mapping-between-sql-data-types-and-java-data-types",children:"Mapping between SQL data types and Java data types"}),'" section of this topic.']}),"\n"]}),"\n",(0,a.jsxs)(n.table,{children:[(0,a.jsx)(n.thead,{children:(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.th,{children:"Method"}),(0,a.jsx)(n.th,{children:"Description"})]})}),(0,a.jsx)(n.tbody,{children:(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"void windowUpdate(State state, int, int, int , int, ...)"}),(0,a.jsxs)(n.td,{children:["Updates the data of the window. For more information about UDWFs, see ",(0,a.jsx)(n.a,{href:"/docs/2.5/sql-reference/sql-functions/Window_function",children:"Window functions"}),". Every time when you enter a row as input, this method obtains the window information and updates intermediate results accordingly.",(0,a.jsxs)("ul",{children:[(0,a.jsxs)("li",{children:[(0,a.jsx)(n.code,{children:"peer_group_start"}),": the start position of the current partition. ",(0,a.jsx)(n.code,{children:"PARTITION BY"})," is used in the OVER clause to specify a partition column. Rows with the same values in the partition column are considered to be in the same partition."]}),(0,a.jsxs)("li",{children:[(0,a.jsx)(n.code,{children:"peer_group_end"}),": the end position of the current partition."]}),(0,a.jsxs)("li",{children:[(0,a.jsx)(n.code,{children:"frame_start"}),": the start position of the current window frame. The window frame clause specifies a calculation range, which covers the current row and the rows that are within a specified distance to the current row. For example, ",(0,a.jsx)(n.code,{children:"ROWS BETWEEN 1 PRECEDING AND 1 FOLLOWING"})," specifies a calculation range that covers the current row, the previous row before the current row, and the following row after the current row."]}),(0,a.jsxs)("li",{children:[(0,a.jsx)(n.code,{children:"frame_end"}),": the end position of the current window frame."]}),(0,a.jsxs)("li",{children:[(0,a.jsx)(n.code,{children:"inputs"}),": the data that is entered as the input to a window. The data is an array package that supports only specific data types. In this example, INT values are entered as input, and the array package is Integer[]."]})]})]})]})})]}),"\n",(0,a.jsx)(n.h4,{id:"compile-a-udtf",children:"Compile a UDTF"}),"\n",(0,a.jsx)(n.p,{children:"A UDTF reads one row of data and returns multiple values that can be considered to be a table. Table-valued functions are typically used to transform rows into columns."}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"NOTE"})}),"\n",(0,a.jsx)(n.p,{children:"StarRocks allows a UDTF to return a table that consists of multiple rows and one column."}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["Suppose that you want to compile a UDTF named ",(0,a.jsx)(n.code,{children:"MY_UDF_SPLIT"}),". The ",(0,a.jsx)(n.code,{children:"MY_UDF_SPLIT"})," function allows you to use spaces as delimiters and supports request parameters and return parameters of the STRING data type."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-Java",children:'package com.starrocks.udf.sample;\n\npublic class UDFSplit{\n    public String[] process(String in) {\n        if (in == null) return null;\n        return in.split(" ");\n    }\n}\n'})}),"\n",(0,a.jsx)(n.p,{children:"The method defined by the user-defined class must meet the following requirements:"}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"NOTE"})}),"\n",(0,a.jsxs)(n.p,{children:["The data types of the request parameters and return parameters in the method must be the same as those declared in the ",(0,a.jsx)(n.code,{children:"CREATE FUNCTION"})," statement that is to be executed in ",(0,a.jsx)(n.a,{href:"#step-6-create-the-udf-in-starrocks",children:"Step 6"}),' and conform to the mapping that is provided in the "',(0,a.jsx)(n.a,{href:"#mapping-between-sql-data-types-and-java-data-types",children:"Mapping between SQL data types and Java data types"}),'" section of this topic.']}),"\n"]}),"\n",(0,a.jsxs)(n.table,{children:[(0,a.jsx)(n.thead,{children:(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.th,{children:"Method"}),(0,a.jsx)(n.th,{children:"Description"})]})}),(0,a.jsx)(n.tbody,{children:(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"TYPE[] process()"}),(0,a.jsx)(n.td,{children:"Runs the UDTF and returns an array."})]})})]}),"\n",(0,a.jsx)(n.h3,{id:"step-4-package-the-java-project",children:"Step 4: Package the Java project"}),"\n",(0,a.jsx)(n.p,{children:"Run the following command to package the Java project:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-Bash",children:"mvn package\n"})}),"\n",(0,a.jsxs)(n.p,{children:["The following JAR files are generated in the ",(0,a.jsx)(n.strong,{children:"target"})," folder: ",(0,a.jsx)(n.strong,{children:"udf-1.0-SNAPSHOT.jar"})," and ",(0,a.jsx)(n.strong,{children:"udf-1.0-SNAPSHOT-jar-with-dependencies.jar"}),"."]}),"\n",(0,a.jsx)(n.h3,{id:"step-5-upload-the-java-project",children:"Step 5: Upload the Java project"}),"\n",(0,a.jsxs)(n.p,{children:["Upload the JAR file ",(0,a.jsx)(n.strong,{children:"udf-1.0-SNAPSHOT-jar-with-dependencies.jar"})," to an HTTP server that keeps up and running and is accessible to all FEs and BEs in your StarRocks cluster. Then, run the following command to deploy the file:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-Bash",children:"mvn deploy \n"})}),"\n",(0,a.jsx)(n.p,{children:"You can set up a simple HTTP server by using Python and upload the JAR file to that HTTP server."}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"NOTE"})}),"\n",(0,a.jsxs)(n.p,{children:["In ",(0,a.jsx)(n.a,{href:"#step-6-create-the-udf-in-starrocks",children:"Step 6"}),", the FEs will check the JAR file that contains the code for the UDF and calculate the checksum, and the BEs will download and execute the JAR file."]}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"step-6-create-the-udf-in-starrocks",children:"Step 6: Create the UDF in StarRocks"}),"\n",(0,a.jsx)(n.p,{children:"After you upload the JAR file mentioned above, you can create the UDF you have compiled in StarRocks."}),"\n",(0,a.jsx)(n.h4,{id:"syntax",children:"Syntax"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:'CREATE [AGGREGATE | TABLE] FUNCTION function_name\n(arg_type [, ...])\nRETURNS return_type\nPROPERTIES ("key" = "value" [, ...])\n'})}),"\n",(0,a.jsx)(n.h4,{id:"parameters",children:"Parameters"}),"\n",(0,a.jsxs)(n.table,{children:[(0,a.jsx)(n.thead,{children:(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.th,{children:(0,a.jsx)(n.strong,{children:"Parameter"})}),(0,a.jsx)(n.th,{children:(0,a.jsx)(n.strong,{children:"Required"})}),(0,a.jsx)(n.th,{children:(0,a.jsx)(n.strong,{children:"Description"})})]})}),(0,a.jsxs)(n.tbody,{children:[(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"AGGREGATE"}),(0,a.jsx)(n.td,{children:"No"}),(0,a.jsx)(n.td,{children:"Whether to create a UDAF or UDWF."})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"TABLE"}),(0,a.jsx)(n.td,{children:"No"}),(0,a.jsxs)(n.td,{children:["Whether to create a UDTF. If both ",(0,a.jsx)(n.code,{children:"AGGREGATE"})," and ",(0,a.jsx)(n.code,{children:"TABLE"})," are not specified, a Scalar function is created."]})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"function_name"}),(0,a.jsx)(n.td,{children:"Yes"}),(0,a.jsxs)(n.td,{children:["The name of the function you want to create. You can include the name of the database in this parameter, for example,",(0,a.jsx)(n.code,{children:"db1.my_func"}),". If ",(0,a.jsx)(n.code,{children:"function_name"})," includes the database name, the UDF is created in that database. Otherwise, the UDF is created in the current database. The name of the new function and its parameters cannot be the same as an existing name in the destination database. Otherwise, the function cannot be created. The creation succeeds if the function name is the same but the parameters are different."]})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"arg_type"}),(0,a.jsx)(n.td,{children:"Yes"}),(0,a.jsxs)(n.td,{children:["Argument type of the function. The added argument can be represented by ",(0,a.jsx)(n.code,{children:", ..."}),". For the supported data types, see ",(0,a.jsx)(n.a,{href:"#mapping-between-sql-data-types-and-java-data-types",children:"Mapping between SQL data types and Java data types"}),"."]})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"return_type"}),(0,a.jsx)(n.td,{children:"Yes"}),(0,a.jsxs)(n.td,{children:["The return type of the function. For the supported data types, see ",(0,a.jsx)(n.a,{href:"#mapping-between-sql-data-types-and-java-data-types",children:"Java UDF"}),"."]})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"PROPERTIES"}),(0,a.jsx)(n.td,{children:"Yes"}),(0,a.jsx)(n.td,{children:"Properties of the function, which vary depending on the type of the UDF to create."})]})]})]}),"\n",(0,a.jsx)(n.h4,{id:"create-a-scalar-udf",children:"Create a scalar UDF"}),"\n",(0,a.jsx)(n.p,{children:"Run the following command to create the scalar UDF you have compiled in the preceding example:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-SQL",children:'CREATE FUNCTION MY_UDF_JSON_GET(string, string) \nRETURNS string\nproperties (\n    "symbol" = "com.starrocks.udf.sample.UDFJsonGet", \n    "type" = "StarrocksJar",\n    "file" = "http://http_host:http_port/udf-1.0-SNAPSHOT-jar-with-dependencies.jar"\n);\n'})}),"\n",(0,a.jsxs)(n.table,{children:[(0,a.jsx)(n.thead,{children:(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.th,{children:"Parameter"}),(0,a.jsx)(n.th,{children:"Description"})]})}),(0,a.jsxs)(n.tbody,{children:[(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"symbol"}),(0,a.jsxs)(n.td,{children:["The name of the class for the Maven project to which the UDF belongs. The value of this parameter is in the ",(0,a.jsx)(n.code,{children:"<package_name>.<class_name>"})," format."]})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"type"}),(0,a.jsxs)(n.td,{children:["The type of the UDF. Set the value to ",(0,a.jsx)(n.code,{children:"StarrocksJar"}),", which specifies that the UDF is a Java-based function."]})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"file"}),(0,a.jsxs)(n.td,{children:["The HTTP URL from which you can download the JAR file that contains the code for the UDF. The value of this parameter is in the ",(0,a.jsx)(n.code,{children:"http://<http_server_ip>:<http_server_port>/<jar_package_name>"})," format."]})]})]})]}),"\n",(0,a.jsx)(n.h4,{id:"create-a-udaf",children:"Create a UDAF"}),"\n",(0,a.jsx)(n.p,{children:"Run the following command to create the UDAF you have compiled in the preceding example:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-SQL",children:'CREATE AGGREGATE FUNCTION MY_SUM_INT(INT) \nRETURNS INT\nPROPERTIES \n( \n    "symbol" = "com.starrocks.udf.sample.SumInt", \n    "type" = "StarrocksJar",\n    "file" = "http://http_host:http_port/udf-1.0-SNAPSHOT-jar-with-dependencies.jar"\n);\n'})}),"\n",(0,a.jsxs)(n.p,{children:["The descriptions of the parameters in PROPERTIES are the same as those in ",(0,a.jsx)(n.a,{href:"#create-a-scalar-udf",children:"Create a scalar UDF"}),"."]}),"\n",(0,a.jsx)(n.h4,{id:"create-a-udwf",children:"Create a UDWF"}),"\n",(0,a.jsx)(n.p,{children:"Run the following command to create the UDWF you have compiled in the preceding example:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-SQL",children:'CREATE AGGREGATE FUNCTION MY_WINDOW_SUM_INT(Int)\nRETURNS Int\nproperties \n(\n    "analytic" = "true",\n    "symbol" = "com.starrocks.udf.sample.WindowSumInt", \n    "type" = "StarrocksJar", \n    "file" = "http://http_host:http_port/udf-1.0-SNAPSHOT-jar-with-dependencies.jar"    \n);\n'})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"analytic"}),": Whether the UDF is a window function. Set the value to ",(0,a.jsx)(n.code,{children:"true"}),". The descriptions of other properties are the same as those in ",(0,a.jsx)(n.a,{href:"#create-a-scalar-udf",children:"Create a scalar UDF"}),"."]}),"\n",(0,a.jsx)(n.h4,{id:"create-a-udtf",children:"Create a UDTF"}),"\n",(0,a.jsx)(n.p,{children:"Run the following command to create the UDTF you have compiled in the preceding example:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-SQL",children:'CREATE TABLE FUNCTION MY_UDF_SPLIT(string)\nRETURNS string\nproperties \n(\n    "symbol" = "com.starrocks.udf.sample.UDFSplit", \n    "type" = "StarrocksJar", \n    "file" = "http://http_host:http_port/udf-1.0-SNAPSHOT-jar-with-dependencies.jar"\n);\n'})}),"\n",(0,a.jsxs)(n.p,{children:["The descriptions of the parameters in PROPERTIES are the same as those in ",(0,a.jsx)(n.a,{href:"#create-a-scalar-udf",children:"Create a scalar UDF"}),"."]}),"\n",(0,a.jsx)(n.h3,{id:"step-7-use-the-udf",children:"Step 7: Use the UDF"}),"\n",(0,a.jsx)(n.p,{children:"After you create the UDF, you can test and use it based on your business needs."}),"\n",(0,a.jsx)(n.h4,{id:"use-a-scalar-udf",children:"Use a scalar UDF"}),"\n",(0,a.jsx)(n.p,{children:"Run the following command to use the scalar UDF you have created in the preceding example:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-SQL",children:'SELECT MY_UDF_JSON_GET(\'{"key":"{\\\\"in\\\\":2}"}\', \'$.key.in\');\n'})}),"\n",(0,a.jsx)(n.h4,{id:"use-a-udaf",children:"Use a UDAF"}),"\n",(0,a.jsx)(n.p,{children:"Run the following command to use the UDAF you have created in the preceding example:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-SQL",children:"SELECT MY_SUM_INT(col1);\n"})}),"\n",(0,a.jsx)(n.h4,{id:"use-a-udwf",children:"Use a UDWF"}),"\n",(0,a.jsx)(n.p,{children:"Run the following command to use the UDWF you have created in the preceding example:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-SQL",children:"SELECT MY_WINDOW_SUM_INT(intcol) \n            OVER (PARTITION BY intcol2\n                  ORDER BY intcol3\n                  ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)\nFROM test_basic;\n"})}),"\n",(0,a.jsx)(n.h4,{id:"use-a-udtf",children:"Use a UDTF"}),"\n",(0,a.jsx)(n.p,{children:"Run the following command to use the UDTF you have created in the preceding example:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-Plain",children:'-- Suppose that you have a table named t1, and the information about its columns a, b, and c1 is as follows:\nSELECT t1.a,t1.b,t1.c1 FROM t1;\n> output:\n1,2.1,"hello world"\n2,2.2,"hello UDTF."\n\n-- Run the MY_UDF_SPLIT() function.\nSELECT t1.a,t1.b, MY_UDF_SPLIT FROM t1, MY_UDF_SPLIT(t1.c1); \n> output:\n1,2.1,"hello"\n1,2.1,"world"\n2,2.2,"hello"\n2,2.2,"UDTF."\n'})}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"NOTE"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["The first ",(0,a.jsx)(n.code,{children:"MY_UDF_SPLIT"})," in the preceding code snippet is the alias of the column that is returned by the second ",(0,a.jsx)(n.code,{children:"MY_UDF_SPLIT"}),", which is a function."]}),"\n",(0,a.jsxs)(n.li,{children:["You cannot use ",(0,a.jsx)(n.code,{children:"AS t2(f1)"})," to specify the aliases of the table and its columns that are to be returned."]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"view-udfs",children:"View UDFs"}),"\n",(0,a.jsx)(n.p,{children:"Run the following command to query UDFs:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-SQL",children:"SHOW FUNCTIONS;\n"})}),"\n",(0,a.jsxs)(n.p,{children:["For more information, see ",(0,a.jsx)(n.a,{href:"/docs/2.5/sql-reference/sql-statements/data-definition/show-functions",children:"SHOW FUNCTIONS"}),"."]}),"\n",(0,a.jsx)(n.h2,{id:"drop-udf",children:"Drop UDF"}),"\n",(0,a.jsx)(n.p,{children:"Run the following command to drop a UDF:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-SQL",children:"DROP FUNCTION <function_name>(arg_type [, ...]);\n"})}),"\n",(0,a.jsxs)(n.p,{children:["For more information, see ",(0,a.jsx)(n.a,{href:"/docs/2.5/sql-reference/sql-statements/data-definition/drop-function",children:"DROP FUNCTION"}),"."]}),"\n",(0,a.jsx)(n.h2,{id:"mapping-between-sql-data-types-and-java-data-types",children:"Mapping between SQL data types and Java data types"}),"\n",(0,a.jsxs)(n.table,{children:[(0,a.jsx)(n.thead,{children:(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.th,{children:"SQL TYPE"}),(0,a.jsx)(n.th,{children:"Java TYPE"})]})}),(0,a.jsxs)(n.tbody,{children:[(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"BOOLEAN"}),(0,a.jsx)(n.td,{children:"java.lang.Boolean"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"TINYINT"}),(0,a.jsx)(n.td,{children:"java.lang.Byte"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"SMALLINT"}),(0,a.jsx)(n.td,{children:"java.lang.Short"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"INT"}),(0,a.jsx)(n.td,{children:"java.lang.Integer"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"BIGINT"}),(0,a.jsx)(n.td,{children:"java.lang.Long"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"FLOAT"}),(0,a.jsx)(n.td,{children:"java.lang.Float"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"DOUBLE"}),(0,a.jsx)(n.td,{children:"java.lang.Double"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"STRING/VARCHAR"}),(0,a.jsx)(n.td,{children:"java.lang.String"})]})]})]}),"\n",(0,a.jsx)(n.h2,{id:"parameter-settings",children:"Parameter settings"}),"\n",(0,a.jsxs)(n.p,{children:["Configure the following environment variable in the ",(0,a.jsx)(n.strong,{children:"be/conf/hadoop_env.sh"})," file of each Java virtual machine (JVM) in your StarRocks cluster to control memory usage. You can also configure other parameters in the file."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-Bash",children:'export LIBHDFS_OPTS="-Xloggc:$STARROCKS_HOME/log/be.gc.log -server"\n'})}),"\n",(0,a.jsx)(n.h2,{id:"faq",children:"FAQ"}),"\n",(0,a.jsx)(n.p,{children:"Can I use static variables when I create UDFs? Do the static variables of different UDFs have mutual impacts on each other?"}),"\n",(0,a.jsx)(n.p,{children:"Yes, you can use static variables when you compile UDFs. The static variables of different UDFs are isolated from each other and do not affect each other even if the UDFs have classes with identical names."})]})}const h=function(e={}){const{wrapper:n}=Object.assign({},(0,s.ah)(),e.components);return n?(0,a.jsx)(n,Object.assign({},e,{children:(0,a.jsx)(o,e)})):o(e)}},11151:(e,n,t)=>{t.d(n,{Zo:()=>d,ah:()=>r});var a=t(67294);const s=a.createContext({});function r(e){const n=a.useContext(s);return a.useMemo((()=>"function"==typeof e?e(n):{...n,...e}),[n,e])}const i={};function d({components:e,children:n,disableParentContext:t}){let d;return d=t?"function"==typeof e?e({}):e||i:r(e),a.createElement(s.Provider,{value:d},n)}}}]);