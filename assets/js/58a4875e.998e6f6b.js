"use strict";(self.webpackChunkstarrocks=self.webpackChunkstarrocks||[]).push([[82570],{93927:(t,e,n)=>{n.r(e),n.d(e,{assets:()=>c,contentTitle:()=>r,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>d});var i=n(85893),a=n(11151);const o={displayed_sidebar:"documentation"},r="Automatic partitioning",s={id:"table_design/automatic_partitioning",title:"Automatic partitioning",description:"This topic describes how to create a table that supports automatic partitioning. This topic also describes the usage notes and limits of automatic partitioning.",source:"@site/versioned_docs/version-3.0/table_design/automatic_partitioning.md",sourceDirName:"table_design",slug:"/table_design/automatic_partitioning",permalink:"/doc/docs/3.0/table_design/automatic_partitioning",draft:!1,unlisted:!1,editUrl:"https://github.com/StarRocks/starrocks/edit/main/docs/table_design/automatic_partitioning.md",tags:[],version:"3.0",frontMatter:{displayed_sidebar:"documentation"},sidebar:"documentation"},c={},d=[{value:"Introduction",id:"introduction",level:2},{value:"Enable automatic partitioning",id:"enable-automatic-partitioning",level:2},{value:"Syntax",id:"syntax",level:3},{value:"Parameters",id:"parameters",level:3},{value:"Examples",id:"examples",level:2},{value:"Usage notes",id:"usage-notes",level:2},{value:"Limits",id:"limits",level:2}];function l(t){const e=Object.assign({h1:"h1",p:"p",h2:"h2",h3:"h3",pre:"pre",code:"code",ul:"ul",li:"li",a:"a"},(0,a.ah)(),t.components);return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(e.h1,{id:"automatic-partitioning",children:"Automatic partitioning"}),"\n",(0,i.jsx)(e.p,{children:"This topic describes how to create a table that supports automatic partitioning. This topic also describes the usage notes and limits of automatic partitioning."}),"\n",(0,i.jsx)(e.h2,{id:"introduction",children:"Introduction"}),"\n",(0,i.jsx)(e.p,{children:"To make partitions creation more easy to use and flexible, StarRocks supports the partitioning expression and automatic partitioning since version 3.0. You only need to specify a partition column of the DATE or DATETIME data type and a partition granularity (year, month, day, or hour) in the partition expression, which includes a time function. With this implicit partitioning method implemented by using a expression, you do not need to create a large number of partitions in advance. StarRocks automatically creates partitions when new data is written. It is recommended that you prioritize using automatic partitioning."}),"\n",(0,i.jsx)(e.h2,{id:"enable-automatic-partitioning",children:"Enable automatic partitioning"}),"\n",(0,i.jsx)(e.h3,{id:"syntax",children:"Syntax"}),"\n",(0,i.jsx)(e.p,{children:"The PARTITION BY clause contains a function expression that specifies the partition granularity and partition column for automatic partitioning."}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-SQL",children:'PARTITION BY date_trunc(<time_unit>,<partition_column_name>)\n...\n[PROPERTIES("partition_live_number" = "xxx")];\n'})}),"\n",(0,i.jsx)(e.p,{children:"Or"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-SQL",children:'PARTITION BY time_slice(<partition_column_name>,INTERVAL N <time_unit>[, boundary]))\n...\n[PROPERTIES("partition_live_number" = "xxx")];\n'})}),"\n",(0,i.jsx)(e.h3,{id:"parameters",children:"Parameters"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["Functions: Currently, only the ",(0,i.jsx)(e.a,{href:"/doc/docs/3.0/sql-reference/sql-functions/date-time-functions/date_trunc",children:"date_trunc"})," and ",(0,i.jsx)(e.a,{href:"/doc/docs/3.0/sql-reference/sql-functions/date-time-functions/time_slice",children:"time_slice"})," functions are supported. If you use the function ",(0,i.jsx)(e.code,{children:"time_slice"}),", you do not need to pass the ",(0,i.jsx)(e.code,{children:"boundary"})," parameter. It is because in this scenario, the default and valid value for this parameter is ",(0,i.jsx)(e.code,{children:"floor"}),", and the value can not be ",(0,i.jsx)(e.code,{children:"ceil"}),"."]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"time_unit"}),": the partition granularity, which can be ",(0,i.jsx)(e.code,{children:"hour"}),", ",(0,i.jsx)(e.code,{children:"day"}),", ",(0,i.jsx)(e.code,{children:"month"})," or ",(0,i.jsx)(e.code,{children:"year"}),". The ",(0,i.jsx)(e.code,{children:"week"})," partition granularity is not supported. If the partition granularity is ",(0,i.jsx)(e.code,{children:"hour"}),", the partition column must be of the DATETIME data type and cannot be of the DATE data type."]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"partition_column_name"}),": the name of the partition column. The partition type is RANGE, and therefore the partition column can only be of the DATE or DATETIME data type. Currently, you can specify only one partition column and multiple partition columns are not supported. If the ",(0,i.jsx)(e.code,{children:"date_trunc"})," function is used, the partition column can be of the DATE or DATETIME data type. If the ",(0,i.jsx)(e.code,{children:"time_slice"})," function is used, the partition column must be of the DATETIME data type. The partition column allows ",(0,i.jsx)(e.code,{children:"NULL"})," values. If the partition column is of the DATE data type, the supported range is [0000-01-01 ~ 9999-12-31]. If the partition column is of the DATETIME data type, the supported range is [0000-01-01 01:01:01 ~ 9999-12-31 23:59:59]."]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"partition_live_number"}),': the number of the most recent partitions to be retained. "Recent" refers to that the partitions are sorted in chronological order, with the current date as a benchmark, the number of partitions that counted backwards are kept, and the rest of the partitions are deleted. StarRocks schedules tasks to manage the number of partitions, and the scheduling interval can be configured through the FE dynamic parameter ',(0,i.jsx)(e.code,{children:"dynamic_partition_check_interval_seconds"}),", which defaults to 600 seconds (10 minutes). Suppose that the current date is April 4, 2023, ",(0,i.jsx)(e.code,{children:"partition_live_number"})," is set to ",(0,i.jsx)(e.code,{children:"2"}),", and the partitions include p20230401, p20230402, p20230403, p20230404. The partitions p20230403, p20230404 are retained and other partitions are deleted. If dirty data is loaded, such as data from the future dates April 5 and April 6, partitions include p20230401, p20230402, p20230403, p20230404, p20230405, and p20230406. Then partitions p20230403, p20230404, p20230405, p20230406 are retained and the other partitions are deleted."]}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"examples",children:"Examples"}),"\n",(0,i.jsxs)(e.p,{children:["Example 1: Use the ",(0,i.jsx)(e.code,{children:"date_trunc"})," function to create a table that supports automatic partitioning. Set the partition granularity to ",(0,i.jsx)(e.code,{children:"day"})," and the partition column to ",(0,i.jsx)(e.code,{children:"event_day"}),"."]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-SQL",children:"CREATE TABLE site_access (\n    event_day DATETIME NOT NULL,\n    site_id INT DEFAULT '10',\n    city_code VARCHAR(100),\n    user_name VARCHAR(32) DEFAULT '',\n    pv BIGINT DEFAULT '0'\n)\nDUPLICATE KEY(event_day, site_id, city_code, user_name)\nPARTITION BY date_trunc('day', event_day)\nDISTRIBUTED BY HASH(event_day, site_id)\nPROPERTIES(\n    \"replication_num\" = \"1\"\n);\n"})}),"\n",(0,i.jsxs)(e.p,{children:["When the following two data rows are inserted, StarRocks automatically creates two partitions, ",(0,i.jsx)(e.code,{children:"p20230226"})," and ",(0,i.jsx)(e.code,{children:"p20230227"}),", whose ranges are [2023-02-26 00:00:00, 2023-02-27 00:00:00) and [2023-02-27 00:00:00, 2023-02-28 00:00:00) respectively."]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-SQL",children:'-- insert two data rows\nINSERT INTO site_access VALUES \n("2023-02-26 20:12:04",002,"New York","Sam Smith",1),\n("2023-02-27 21:06:54",001,"Los Angeles","Taylor Swift",1);\n\n-- view partitions\nSHOW PARTITIONS FROM site_access\\G\n*************************** 1. row ***************************\n             PartitionId: 135846228\n           PartitionName: p20230226\n          VisibleVersion: 2\n      VisibleVersionTime: 2023-03-22 14:50:17\n      VisibleVersionHash: 0\n                   State: NORMAL\n            PartitionKey: event_day\n                   Range: [types: [DATETIME]; keys: [2023-02-26 00:00:00]; ..types: [DATETIME]; keys: [2023-02-27 00:00:00]; )\n         DistributionKey: event_day, site_id\n                 Buckets: 6\n          ReplicationNum: 1\n           StorageMedium: HDD\n            CooldownTime: 9999-12-31 23:59:59\nLastConsistencyCheckTime: NULL\n                DataSize: 0B\n              IsInMemory: false\n                RowCount: 0\n*************************** 2. row ***************************\n             PartitionId: 135846215\n           PartitionName: p20230227\n          VisibleVersion: 2\n      VisibleVersionTime: 2023-03-22 14:50:17\n      VisibleVersionHash: 0\n                   State: NORMAL\n            PartitionKey: event_day\n                   Range: [types: [DATETIME]; keys: [2023-02-27 00:00:00]; ..types: [DATETIME]; keys: [2023-02-28 00:00:00]; )\n         DistributionKey: event_day, site_id\n                 Buckets: 6\n          ReplicationNum: 1\n           StorageMedium: HDD\n            CooldownTime: 9999-12-31 23:59:59\nLastConsistencyCheckTime: NULL\n                DataSize: 0B\n              IsInMemory: false\n                RowCount: 0\n2 rows in set (0.00 sec)\n'})}),"\n",(0,i.jsxs)(e.p,{children:["Example 2: Use the ",(0,i.jsx)(e.code,{children:"date_trunc"})," function to create a table that supports automatic partitioning. Set the partition granularity to ",(0,i.jsx)(e.code,{children:"month"})," and the partition column to ",(0,i.jsx)(e.code,{children:"event_day"}),". Additionally, create some historical partitions before loading data and specify that the table only retains the most recent three partitions."]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-SQL",children:'CREATE TABLE site_access(\n    event_day DATETIME NOT NULL,\n    site_id INT DEFAULT \'10\',\n    city_code VARCHAR(100),\n    user_name VARCHAR(32) DEFAULT \'\',\n    pv BIGINT DEFAULT \'0\'\n) \nDUPLICATE KEY(event_day, site_id, city_code, user_name)\nPARTITION BY date_trunc(\'month\', event_day)(\n    START ("2022-06-01") END ("2022-12-01") EVERY (INTERVAL 1 month)\n)\nDISTRIBUTED BY HASH(event_day, site_id)\nPROPERTIES(\n    "partition_live_number" = "3",\n    "replication_num" = "1"\n);\n'})}),"\n",(0,i.jsxs)(e.p,{children:["Example 3: Use the ",(0,i.jsx)(e.code,{children:"time_slice"})," function to create a table that supports automatic partitioning. Set the partition granularity to 7 days and the partition column to ",(0,i.jsx)(e.code,{children:"event_day"}),"."]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-SQL",children:"CREATE TABLE site_access(\n    event_day DATETIME NOT NULL,\n    site_id INT DEFAULT '10',\n    city_code VARCHAR(100),\n    user_name VARCHAR(32) DEFAULT '',\n    pv BIGINT DEFAULT '0'\n)\nDUPLICATE KEY(event_day, site_id, city_code, user_name)\nPARTITION BY time_slice(event_day, INTERVAL 7 day)\nDISTRIBUTED BY HASH(event_day, site_id)\nPROPERTIES(\"replication_num\" = \"1\");\n"})}),"\n",(0,i.jsx)(e.h2,{id:"usage-notes",children:"Usage notes"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["StarRocks automatically creates partitions and sets the start time and end time of the partitions based on the loaded data and the automatic partitioning rule configured at table creation. For example, if the value of the partition column for the data row is ",(0,i.jsx)(e.code,{children:"2015-06-05"}),", and the partition granularity is ",(0,i.jsx)(e.code,{children:"month"}),", then a partition named ",(0,i.jsx)(e.code,{children:"p201506"})," is created with a range of [2015-06-01, 2015-07-01) rather than [2015-06-05, 2015-07-05)."]}),"\n",(0,i.jsxs)(e.li,{children:["For tables that support automatic partitioning, StarRocks sets the default maximum number of automatically created partitions to 4096, which can be configured by the FE parameter ",(0,i.jsx)(e.code,{children:"max_automatic_partition_number"}),". This parameter can prevent you from accidentally creating too many partitions, such as when specifying a partition column of DATETIME type with a too-fine partition granularity like ",(0,i.jsx)(e.code,{children:"hour"}),", which can generate a large number of partitions."]}),"\n",(0,i.jsx)(e.li,{children:"During data loading, StarRocks automatically creates some partitions based on the loaded data, but if the load job fails for some reason, the partitions that are automatically created by StarRocks cannot be automatically deleted."}),"\n",(0,i.jsxs)(e.li,{children:["Note that the ",(0,i.jsx)(e.code,{children:"PARTITION BY"})," clause is only used to calculate the partition range for the loaded data and does not change the values of the data. For example, if the original data is ",(0,i.jsx)(e.code,{children:"2023-02-27 21:06:54"}),", the function expression in ",(0,i.jsx)(e.code,{children:"PARTITION BY date_trunc('day', event_day)"})," computes it as 2023-02-27 00:00:00 and infers that it belongs to the partition range [2023-02-27 00:00:00, 2023-02-28 00:00:00), but the data is still written as ",(0,i.jsx)(e.code,{children:"2023-02-27 21:06:54"}),". If you want the written data's value to be the same as the start time of the partition range, you need to use the function specified in the ",(0,i.jsx)(e.code,{children:"PARTITION BY"})," clause, such as ",(0,i.jsx)(e.code,{children:"date_trunc"}),", on the ",(0,i.jsx)(e.code,{children:"event_day"})," column when creating a load job."]}),"\n",(0,i.jsx)(e.li,{children:"The naming rules for automatic partitioning are consistent with the naming rules for dynamic partitioning."}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"limits",children:"Limits"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"Only the range partitioning type is supported, whereas the list partitioning type is not supported."}),"\n",(0,i.jsxs)(e.li,{children:["When a table that supports automatic partitioning is created, it is generally not recommended to create partitions in advance. If you need to create partitions in advance, you can create multiple partitions all at a time, as shown in the preceding Example 2. The statement in Example 2 has the following limits:","\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"The granularity of the partitions created in advance must be consistent with that of the automatically created partitions."}),"\n",(0,i.jsxs)(e.li,{children:["When you configure automatic partitioning, you can only use the function ",(0,i.jsx)(e.code,{children:"date_trunc"})," rather than ",(0,i.jsx)(e.code,{children:"time_slice"}),"."]}),"\n",(0,i.jsxs)(e.li,{children:["The syntax for creating multiple partitions all at a time only supports an interval of ",(0,i.jsx)(e.code,{children:"1"}),"."]}),"\n",(0,i.jsxs)(e.li,{children:["After a table that supports automatic partitioning is created, you can use ",(0,i.jsx)(e.code,{children:"ALTER TABLE ADD PARTITION"})," to add partitions for that table. And the statement ",(0,i.jsx)(e.code,{children:"ALTER TABLE ADD PARTITION"})," also has the above limits."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.li,{children:"Currently, StarRocks's shared-data mode does not support this feature."}),"\n",(0,i.jsx)(e.li,{children:"Currently, using CTAS to create a table that supports automatic partitioning is not supported."}),"\n",(0,i.jsx)(e.li,{children:"Currently, using Spark Load to load data to tables that support automatic partitioning is not supported."}),"\n",(0,i.jsx)(e.li,{children:"If you use automatic partitioning, you can only roll back your StarRocks cluster to version 2.5.4 or later."}),"\n",(0,i.jsx)(e.li,{children:"To view the specific information of automatically created partitions, use the SHOW PARTITIONS FROM statement, rather than the SHOW CREATE TABLE statement."}),"\n"]})]})}const h=function(t={}){const{wrapper:e}=Object.assign({},(0,a.ah)(),t.components);return e?(0,i.jsx)(e,Object.assign({},t,{children:(0,i.jsx)(l,t)})):l(t)}},11151:(t,e,n)=>{n.d(e,{Zo:()=>s,ah:()=>o});var i=n(67294);const a=i.createContext({});function o(t){const e=i.useContext(a);return i.useMemo((()=>"function"==typeof t?t(e):{...e,...t}),[e,t])}const r={};function s({components:t,children:e,disableParentContext:n}){let s;return s=n?"function"==typeof t?t({}):t||r:o(t),i.createElement(a.Provider,{value:s},e)}}}]);